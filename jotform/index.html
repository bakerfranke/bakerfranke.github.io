<html>
<head>
         

    <script src="https://js.jotform.com/JotForm.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.js" integrity="sha256-16cdPddA6VdVInumRGo6IbivbERE8p7CQR3HzTBuELA=" crossorigin="anonymous"></script>

    <style>
    body{
        
        padding-left: 40px;
        font-size: 11pt;
        width: 850px;

    }
    .matrix_table{
       
        border-collapse: collapse;
        font-size: 11pt;
        width: 100%;

    }
    .matrix_table td{
        vertical-align: top;
        border: solid 1px black;
        padding: 5px;
        
    }
    .matrix_rows{
        width: 66%;
    }
    .options{
        width: 50%;
    }
    .pagebreak{
        text-align: right;
        background-color: #d9f3f5;
        font-size: 8pt;
        padding: 1px;
        font-family: sans-serif;
    }
    #userinput{
        background-color: #DDDDDD;
        margin-bottom: 4px;
    }
    .hiddenkey{
        color: rgba(0,0,0,0);
        font-family: sans-serif;
        font-size: 9pt;
    }
    .hiddenkey:hover{
        color: rgba(0,0,0,1);
    }
    ol{
        padding-inline-start: 20px;
    }
    </style>
 <script>
var my_apikey = "";
var my_formid = "";
var item_response_count = 0;
var allQs = {};

function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, '\\$&');
    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
}

function loadLocalstorage(){
    if(localStorage["my_apikey"] !==undefined){
        $("#apikey").val(localStorage["my_apikey"] );
        $("#makeapikey").hide();
    }
    if(localStorage["my_formid"] !==undefined){
        $("#formid").val(localStorage["my_formid"] );
    }

    // QUERY STRING FORM ID overrides local storage value
    var param_formid = getParameterByName("formid");
    if(param_formid!==null){
         $("#formid").val(param_formid);
    }
}
function loadJF(){
    
    my_apikey = $("#apikey").val();
    my_formid = $("#formid").val();

    //JF.initialize( {apiKey: "db67fed2f8281454859dcb1687a04fbf"} ); 
    JF.initialize( {apiKey: my_apikey} ); 

    localStorage["my_apikey"] = my_apikey;

    JF.getForms({limit: "1000", orderby: "updated_at"}, function(response){
        /**
         successful response including user forms array
         *
         */

        // console.log("# forms = "+response.length)
        // for(var i=0; i<response.length; i++){
        //     console.log(response[i].title);
        // }

        var dropdown = $('#form-pulldown');

        dropdown.empty();

        dropdown.append('<option selected="true" disabled>Choose a form</option>');
        dropdown.prop('selectedIndex', 0);

        for(var i=0; i<response.length; i++){
            dropdown.append($('<option></option>').attr('value', response[i].id).text(response[i].title));
            if(response[i].id == my_formid){ dropdown.prop('selectedIndex', i+1); }
        }
    });

    localStorage["my_formid"] = my_formid;

    $("#preview_link").attr("href", "https://form.jotform.com/"+my_formid);
    $("#build_link").attr("href", "https://www.jotform.com/build/"+my_formid);
    $("#thislink").attr("href", "https://bakerfranke.github.io/jotform/?formid="+my_formid);

    item_response_count = 0;

    //JF.getFormQuestions("90486182774164", function(response){
    JF.getFormQuestions(my_formid, function(response){
        /**
         successful response including questions of form with given id
         .
         */
        var orderedQList = [];
        for(var i in response){
            var obj = response[i];
            orderedQList[obj.order] = obj;
            //document.write(response[i].qid+" "+response[i].text+"<br/>");
        }
        var outStr = "";

        for(var i in orderedQList){
            var Q = orderedQList[i];

            allQs[Q.name] = Q;
            //outStr += "<input type='text' id='"+Q.name+"' value='"+Q.name+"'><button onClick='updateSlug(\""+Q.qid+"\",\""+Q.name+"\")'>update</button><br>";
            
            if(Q.type=="control_matrix"){
                //document.write(makeMatrixTable(Q));
                outStr+=makeMatrixTable(Q);
            }
            else if(Q.type=="control_radio" || Q.type=="control_checkbox"){
                //document.write(makeSimpleTable(Q));
                outStr += makeSimpleTable(Q);
            }
            else if(Q.type == "control_pagebreak"){
                //document.write("<hr>page break<hr>");
                outStr += "<div class='pagebreak'>page break</div>";
            }
            else if(Q.type == "control_text"){
                //document.write(Q.text);
                outStr += Q.text +"<br/>";
            }
            else if(Q.type=="control_scale"){
                //HACK to make my simpleTable thing work
                Q.options = Q.scaleFrom+" to "+Q.scaleAmount;
                //document.write(makeSimpleTable(Q));
                outStr += makeSimpleTable(Q);

            }
            else if(["control_number","control_textbox","control_textarea"].indexOf(Q.type) >= 0){
                console.log("inside type tcheck");
                Q.options = "[input_box]";
                outStr += makeSimpleTable(Q);
            }
            else{
                // document.write("<b>[" +Q.name+"]</b> ["+Q.type+"] <br/> "+Q.text);
                // document.write("<br/>")
                outStr += "<b>[" +Q.name+"]</b> ["+Q.type+"] <br/> "+Q.text+"<br/>"

            }
        }
        outStr += "<br/><b>Total items: "+item_response_count+"</b>";
        $("#main").html(outStr);

    });

    
}

function updateSlug(id, name){
    console.log("asked to update "+id+", "+name);
    var newSlug = $("#"+name).val();
    console.log("new slug: "+newSlug);


    question = { "name" : newSlug};

    JF.editFormQuestion(my_formid, id, question, function(response){
        // *
        //  successful response including question with given id of form with given id
        //  .
         
        console.log("name updated."+response);
    });

}


function makeMatrixTable(qObj){
    var str = "<div id='"+qObj.name+"' class='question_container'>";
    str +="<b onClick='makeEditableMatrixTable(\""+qObj.name+"\")'>["+qObj.name+"]</b><br>";
    str+="<table class='matrix_table'><tr><td colspan='2' class='preamble'>";
    str+= qObj.text;
    str+="</td></tr><tr><td class='matrix_rows'><ol>";
    // TODO: split on pipes
    var rows = qObj.mrows.split("|");
    for(var i in rows){
        str += "<li> "+rows[i]+"<br/>"; //+"</li>";
        item_response_count++;
    }
    str+="</ol></td><td class='matrix_options'>";
    var cols = qObj.mcolumns.split("|");
    str += "("+cols.length+"pt)<br/>"
    for(var i in cols){
        str += "- "+cols[i]+"<br/>";
    }
    str += "</td></tr></table></div><br>";

    return str;
}


// BAKER NOTE: ToDO -- in inital layout of questions, build question containers, then fill inner html
// with question type so can swap readonly and editable.
function updateQ(qObj_name){

    // copy/paste of makeMatrixTable MINUS the question container.  Fix this later.
    var str ="<b>["+qObj.name+"]</b><br>";
    str+="<table class='matrix_table'><tr><td colspan='2' class='preamble'>";
    str+= qObj.text;
    str+="</td></tr><tr><td class='matrix_rows'><ol>";
    // TODO: split on pipes
    var rows = qObj.mrows.split("|");
    for(var i in rows){
        str += "<li> "+rows[i]+"<br/>"; //+"</li>";
        item_response_count++;
    }
    str+="</ol></td><td class='matrix_options'>";
    var cols = qObj.mcolumns.split("|");
    str += "("+cols.length+"pt)<br/>"
    for(var i in cols){
        str += "- "+cols[i]+"<br/>";
    }
    str += "</td></tr></table><br>";

    $("#"+qObj_name).html(str);

    //return str;

}

function makeEditableMatrixTable(qObj_name){

    qObj = allQs[qObj_name];

    var str="<b>["+qObj.name+"]</b><br>";
    str+="<table class='matrix_table'><tr><td colspan='2' class='preamble'>";
    str+= "<input type=text value='"+qObj.text+"' style='width: 90%'>";
    str+="</td></tr><tr><td class='matrix_rows'><textarea rows=10 style='width: 100%'>";
    // TODO: split on pipes
    var rows = qObj.mrows.split("|");
    for(var i in rows){
        str += rows[i]+"\n"; //+"</li>";
    }
    str+="</textarea></td><td class='matrix_options'>";
    var cols = qObj.mcolumns.split("|");
    str+="<textarea rows="+(cols.length+2)+" style='width: 100%'>"
    for(var i in cols){
        str += cols[i]+"\n";
    }
    str += "</textarea></td></tr>";
    str += "<tr><td align=right colspan=2><button onClick='updateQ(\""+qObj.name+"\")'>save</button></td></tr></table><br>";

    $("#"+qObj.name).html(str);

    //return str;

}

function makeSimpleTable(qObj){

    var str="<b>["+qObj.name+"]</b><br>";
    str+="<table class='matrix_table' ><tr><td>";
    str+= qObj.text;
    str+="</td><td class='options'>";
    var options = qObj.options.split("|");
    //str += options.length+"pt<br/><br/>"
    // if(qObj.type.indexOf("checkbox")>=0) str+= "(select all that apply)<br/>";
    // else if(qObj.type.indexOf("radio")>=0) str+= "(single select)<br/>";
    str += "("+qObj.type.replace("control_","")+")<br/>";

    for(var i in options){
        str += "- "+options[i]+"<br/>";
    }
    str += "</td></tr></table><br>";
    item_response_count++;
    return str;

}

function setFormId(){
    var selected_form_id = $("#form-pulldown")[0].options[$("#form-pulldown")[0].selectedIndex].value
    $("#formid").val(selected_form_id);
    loadJF();
}

</script> 
</head>
<body onLoad="loadLocalstorage(); loadJF();">
<div id="userinput">
    jotform api key:     <input type=text value="" size=30 id="apikey"> 
    <!-- <input type=text value="cbcc52e76debcf9102798e18f6098e32" size=30 id="apikey"> -->
    <!-- <input type=text value="db67fed2f8281454859dcb1687a04fbf" size=30 id="apikey"> --> <button onClick="loadJF()"> Load </button> <a id="makeapikey" href="https://www.jotform.com/myaccount/api">make/get api key</a><br/> 
    form: <select id="form-pulldown" onChange="setFormId()"></select><br/>
    form_id: <input type=text value="" size=20 id="formid"> <a id="build_link" target="_blank" href="">[build link]</a> <a  target="_blank" id="preview_link" href="">[preview link]</a> <a id="thislink" href="https://bakerfranke.github.io/jotform/">[this link]</a><br/>

</div>

<div id="main">

</div>

 
</body>
  

</html>

